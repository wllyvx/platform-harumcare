---
import PrimaryLayout from '../../layouts/PrimaryLayout.astro';
import BlogCardLarge from '../../components/blog/BlogCardLarge.astro';

// Blog interface
interface Blog {
  _id: string;
  title: string;
  content: string;
  image: string;
  slug: string;
  author?: {
    nama: string;
    username: string;
  };
  category: string;
  createdAt: string;
  viewCount: number;
}

// Get query parameters
const { searchParams } = Astro.url;
const page = parseInt(searchParams.get('page') || '1');
const category = searchParams.get('category') || '';
const limit = 9;

// Fetch blogs from API
let blogData: { blogs: Blog[], currentPage: number, totalPages: number, totalBlogs: number } = { 
  blogs: [], 
  currentPage: 1, 
  totalPages: 1, 
  totalBlogs: 0 
};
try {
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000/api';
  const queryParams = new URLSearchParams({
    page: page.toString(),
    limit: limit.toString(),
    status: 'published'
  });
  
  if (category) {
    queryParams.append('category', category);
  }
  
  const apiUrl = `${API_URL}/blog?${queryParams}`;
  const response = await fetch(apiUrl);
  
  if (response.ok) {
    blogData = await response.json();
    console.log('Blog data fetched:', { 
      count: blogData.blogs?.length || 0, 
      total: blogData.totalBlogs || 0 
    });
  } else {
    console.error('Failed to fetch blogs:', response.status, response.statusText);
    const errorText = await response.text();
    console.error('Error response:', errorText);
  }
} catch (error) {
  console.error('Error fetching blogs:', error);
}

const { blogs, currentPage, totalPages, totalBlogs } = blogData;

// Categories for filter
const categories = [
  { value: '', label: 'Semua Kategori' },
  { value: 'umum', label: 'Umum' },
  { value: 'kegiatan', label: 'Kegiatan' },
  { value: 'pengumuman', label: 'Pengumuman' }
];
---

<PrimaryLayout title="Blog - Harum Care Indonesia">
  <main class="min-h-screen bg-gray-50">
    <!-- Hero Section -->
    <section class="bg-blue-600 text-white py-16">
      <div class="max-w-7xl mx-auto px-4">
        <div class="text-center">
          <h1 class="text-4xl md:text-5xl font-bold mb-4">Blog & Artikel</h1>
          <p class="text-xl text-blue-100 max-w-2xl mx-auto">
            Dapatkan informasi terbaru seputar kegiatan, pengumuman, dan artikel dari Harum Care Indonesia
          </p>
        </div>
      </div>
    </section>

    <!-- Filter Section -->
    <section class="py-8 bg-white border-b">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center gap-4">
            <label for="category-filter" class="text-sm font-medium text-gray-700">
              Filter Kategori:
            </label>
            <select 
              id="category-filter" 
              class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              onchange="window.location.href = this.value ? `/blog?category=${this.value}` : '/blog'"
            >
              {categories.map((cat) => (
                <option value={cat.value} selected={cat.value === category}>
                  {cat.label}
                </option>
              ))}
            </select>
          </div>
          
          <div class="text-sm text-gray-600">
            Menampilkan {blogs.length} dari {totalBlogs} blog
          </div>
        </div>
      </div>
    </section>

    <!-- Blog Grid -->
    <section class="py-12">
      <div class="max-w-7xl mx-auto px-4">
        {blogs.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 md:gap-10">
            {blogs.map((item) => (
              <BlogCardLarge
                _id={item._id}
                title={item.title}
                content={item.content}
                image={item.image}
                slug={item.slug}
                author={item.author}
                category={item.category}
                createdAt={item.createdAt}
                viewCount={item.viewCount}
              />
            ))}
          </div>
        ) : (
          <div class="text-center py-16">
            <div class="mb-6">
              <img 
                src="/images/empty-image-placeholder.webp" 
                alt="No blog" 
                class="w-32 h-32 mx-auto opacity-50"
              />
            </div>
            <h3 class="text-2xl font-semibold text-gray-700 mb-2">Tidak Ada Blog</h3>
            <p class="text-gray-500 mb-6">
              {category ? `Tidak ada blog dalam kategori "${category}"` : 'Belum ada blog yang tersedia'}
            </p>
            {category && (
              <a 
                href="/blog" 
                class="inline-block px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
              >
                Lihat Semua Blog
              </a>
            )}
          </div>
        )}

        <!-- Pagination -->
        {totalPages > 1 && (
          <div class="flex justify-center mt-12">
            <nav class="flex items-center gap-2">
              {currentPage > 1 && (
                <a 
                  href={`/blog?page=${currentPage - 1}${category ? `&category=${category}` : ''}`}
                  class="px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                >
                  Sebelumnya
                </a>
              )}
              
              {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => (
                <a 
                  href={`/blog?page=${pageNum}${category ? `&category=${category}` : ''}`}
                  class={`px-4 py-2 text-sm border rounded-md transition-colors ${
                    pageNum === currentPage 
                      ? 'bg-blue-600 text-white border-blue-600' 
                      : 'border-gray-300 hover:bg-gray-50'
                  }`}
                >
                  {pageNum}
                </a>
              ))}
              
              {currentPage < totalPages && (
                <a 
                  href={`/blog?page=${currentPage + 1}${category ? `&category=${category}` : ''}`}
                  class="px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                >
                  Selanjutnya
                </a>
              )}
            </nav>
          </div>
        )}
      </div>
    </section>
  </main>
</PrimaryLayout>
